<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - AreaHealth NG</title>

  <!-- Tailwind CSS (embedded via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] },
          colors: {
            primary: { DEFAULT: '#2563eb' }, // Tailwind blue-600
            brand: '#06b6d4', // cyan-500
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase (compat builds for global firebase.* usage) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    /* Animated gradient header */
    .gradient-header {
      background: linear-gradient(270deg,#06b6d4,#3b82f6,#8b5cf6,#ec4899);
      background-size: 800% 800%;
      animation: gradientShift 12s ease infinite;
    }
    @keyframes gradientShift {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    /* Hide default file inputs; we trigger via label buttons */
    input[type="file"] { display: none; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Header -->
  <header class="gradient-header text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button id="sidebarToggle" class="md:hidden p-2 rounded-lg hover:bg-white/10 focus:outline-none" aria-label="Open menu">
          ☰
        </button>
        <h1 class="text-lg font-semibold tracking-tight">AreaHealth NG</h1>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm md:text-base" id="headerGreeting">Hello 👋</div>
        <img id="headerPic" class="w-10 h-10 rounded-full ring-2 ring-white object-cover cursor-pointer"
             alt="Profile"
             title="Click to update profile picture"
             onclick="document.getElementById('profilePicInput').click()">
      </div>
    </div>
  </header>

  <!-- Shell -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 flex">
    <!-- Sidebar -->
    <aside id="sidebar"
           class="fixed md:static inset-y-0 left-0 w-64 transform -translate-x-full md:translate-x-0 transition-transform duration-200 ease-in-out z-40
                  bg-white shadow md:shadow-none md:bg-transparent md:w-60">
      <nav class="h-full md:h-auto p-4 space-y-1 bg-white md:bg-transparent">
        <a href="index.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">📒 Overview</a>
        <a href="AreaHealth Dashboard.html" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100">🏠 Home</a>
        <a href="Pharmacies..html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">💊 Find Pharmacies</a>
        <a href="Medication.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">📦 Medications</a>
        <a href="Nearby Services.html" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">📍 Nearby Services</a>
        <a href="#" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100">⚙ Settings</a>
        <button onclick="logout()"
                class="w-full text-left flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-rose-50 hover:text-rose-600">
          🚪 Logout
        </button>
      </nav>
    </aside>

    <!-- Overlay for mobile -->
    <div id="overlay" class="fixed inset-0 bg-black/30 hidden z-30 md:hidden"></div>

    <!-- Main -->
    <main class="flex-1 md:ml-6">
      <!-- Welcome -->
      <section class="bg-white shadow-sm rounded-2xl p-5 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
          <div>
            <h2 class="text-xl sm:text-2xl font-semibold">
              Hello, <span id="userName">User</span> 👋
              <span id="verifiedBadge" class="hidden align-middle ml-2 text-xs px-2 py-1 rounded-full bg-green-100 text-green-700">Verified</span>
            </h2>
            <p class="text-slate-600">Welcome to your AreaHealth dashboard.</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="resendVerifyBtn"
                    class="hidden text-xs sm:text-sm px-3 py-2 rounded-lg border border-amber-300 text-amber-700 hover:bg-amber-50">
              Resend verification email
            </button>
            <label for="profilePicInput"
                   class="cursor-pointer text-xs sm:text-sm px-3 py-2 rounded-lg bg-primary text-white hover:bg-blue-700">
              Update Profile Picture
            </label>
            <input type="file" id="profilePicInput" accept="image/*">
          </div>
        </div>
      </section>

      <!-- Quick Stats -->
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-white rounded-2xl shadow-sm p-4">
          <div class="text-slate-500 text-sm">Email Status</div>
          <div id="emailStatus" class="mt-1 font-semibold">Checking…</div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm p-4">
          <div class="text-slate-500 text-sm">Last Login</div>
          <div id="lastLogin" class="mt-1 font-semibold">—</div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm p-4">
          <div class="text-slate-500 text-sm">Documents Uploaded</div>
          <div id="docCount" class="mt-1 font-semibold">0</div>
        </div>
        <div class="bg-white rounded-2xl shadow-sm p-4">
          <div class="text-slate-500 text-sm">Member Since</div>
          <div id="memberSince" class="mt-1 font-semibold">—</div>
        </div>
      </section>

      <!-- Profile + Uploads -->
      <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Profile Card -->
        <div class="bg-white rounded-2xl shadow-sm p-5">
          <div class="flex items-center gap-4">
            <img id="userPic" class="w-20 h-20 rounded-full object-cover ring-2 ring-primary/20" alt="Profile">
            <div>
              <div class="text-lg font-semibold" id="profileName">—</div>
              <div class="text-slate-600 text-sm" id="userEmail">—</div>
            </div>
          </div>
          <div class="mt-4">
            <div id="profileUploadStatus" class="text-sm text-slate-500">No upload in progress.</div>
            <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
              <div id="profileProgress" class="bg-primary h-2 rounded-full" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- Document Upload -->
        <div class="bg-white rounded-2xl shadow-sm p-5">
          <h3 class="font-semibold text-lg">Upload Document</h3>
          <p class="text-slate-600 text-sm mb-3">E.g. prescriptions, lab reports, receipts.</p>
          <label for="documentInput"
                 class="inline-flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-900 cursor-pointer">
            📤 Choose File
          </label>
          <input type="file" id="documentInput">
          <button id="uploadDocBtn"
                  class="ml-2 mt-3 inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
            Upload
          </button>
          <div class="mt-4">
            <div id="docUploadStatus" class="text-sm text-slate-500">No upload in progress.</div>
            <div class="w-full bg-slate-100 rounded-full h-2 mt-2">
              <div id="docProgress" class="bg-primary h-2 rounded-full" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- Recent Documents -->
        <div class="bg-white rounded-2xl shadow-sm p-5">
          <h3 class="font-semibold text-lg mb-2">Recent Documents</h3>
          <ul id="docList" class="space-y-2 text-sm">
            <li class="text-slate-500">No documents yet.</li>
          </ul>
        </div>
      </section>

      <!-- Nearby Services -->
      <section class="bg-white rounded-2xl shadow-sm p-5">
        <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4">
          <div>
            <h3 class="font-semibold text-lg">Nearby Health Services</h3>
            <p class="text-slate-600 text-sm">Search, filter, and get directions. Enable location to see distance.</p>
          </div>
          <div class="flex flex-wrap gap-2">
            <input id="searchBox" placeholder="Search services…"
                   class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            <select id="filterCategory"
                    class="px-3 py-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
              <option value="all">All</option>
              <option value="pharmacy">Pharmacy</option>
              <option value="hospital">Hospital</option>
              <option value="clinic">Clinic</option>
              <option value="laboratory">Laboratory</option>
              <option value="ambulance">Ambulance</option>
              <option value="telemedicine">Telemedicine</option>
              <option value="vaccination">Immunization</option>
            </select>
            <button id="locateBtn"
                    class="px-3 py-2 rounded-lg border border-slate-200 hover:bg-slate-50">
              📍 Use my location
            </button>
          </div>
        </div>

        <div id="servicesGrid" class="mt-5 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Footer -->
      <footer class="text-center text-sm text-slate-500 py-6">
        © 2025 AreaHealth NG. All rights reserved.
      </footer>
    </main>
  </div>

  <script>
    /* -------------------- Firebase Init -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyC79cSDPpC4bbhlRBpu7WhON3j8AMxMLyE",
      authDomain: "areahealth-ng.firebaseapp.com",
      projectId: "areahealth-ng",
      storageBucket: "areahealth-ng.appspot.com",
      messagingSenderId: "986651954303",
      appId: "1:986651954303:web:3f38dc24e246b7047d834a"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    /* ---------------- Sidebar Toggle (mobile) --------------- */
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const sidebarToggle = document.getElementById('sidebarToggle');
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      overlay.classList.remove('hidden');
    }
    function closeSidebar() {
      sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
    }
    sidebarToggle?.addEventListener('click', openSidebar);
    overlay?.addEventListener('click', closeSidebar);
    // Auto close on nav link click (mobile)
    sidebar.querySelectorAll('a,button').forEach(el => {
      el.addEventListener('click', () => { if (window.innerWidth < 768) closeSidebar(); });
    });

    /* ------------------ DOM helpers ------------------ */
    const $ = (id) => document.getElementById(id);
    const headerGreeting = $('headerGreeting');
    const headerPic = $('headerPic');
    const userNameSpan = $('userName');
    const profileName = $('profileName');
    const userEmailSpan = $('userEmail');
    const userPic = $('userPic');
    const verifiedBadge = $('verifiedBadge');
    const emailStatus = $('emailStatus');
    const lastLogin = $('lastLogin');
    const docCount = $('docCount');
    const memberSince = $('memberSince');
    const resendVerifyBtn = $('resendVerifyBtn');

    const profilePicInput = $('profilePicInput');
    const profileProgress = $('profileProgress');
    const profileUploadStatus = $('profileUploadStatus');

    const documentInput = $('documentInput');
    const uploadDocBtn = $('uploadDocBtn');
    const docProgress = $('docProgress');
    const docUploadStatus = $('docUploadStatus');
    const docList = $('docList');

    /* ------------------ Auth State & User Load ------------------ */
    let currentUser = null;
    let userDocRef = null; // Firestore doc ref (users/{uid})
    let userData = null;

    auth.onAuthStateChanged(async (u) => {
      if (!u) {
        // Not logged in → go to login
        window.location.href = "AreaHealth Login.html";
        return;
      }
      currentUser = u;
      userDocRef = db.collection('users').doc(u.uid);

      // Fetch Firestore data
      const snap = await userDocRef.get();
      userData = snap.exists ? snap.data() : null;

      // Populate UI
      const name = (userData && (userData.name || userData.username)) || (u.displayName) || 'User';
      const email = u.email || (userData?.email) || '—';
      const pic = (userData && userData.profilePic) || 'https://via.placeholder.com/120?text=Profile';

      userNameSpan.textContent = name;
      profileName.textContent = name;
      headerGreeting.textContent = `Hello, ${name} 👋`;
      userEmailSpan.textContent = email;
      userPic.src = pic;
      headerPic.src = pic;

      // Stats
      emailStatus.textContent = u.emailVerified ? 'Verified' : 'Not verified';
      verifiedBadge.classList.toggle('hidden', !u.emailVerified);
      resendVerifyBtn.classList.toggle('hidden', !!u.emailVerified);

      lastLogin.textContent = (u.metadata && u.metadata.lastSignInTime) ? new Date(u.metadata.lastSignInTime).toLocaleString() : '—';
      memberSince.textContent = (userData && userData.registeredAt?.toDate) ? userData.registeredAt.toDate().toLocaleDateString() : '—';

      // Documents
      const docs = Array.isArray(userData?.documents) ? userData.documents : (userData?.document ? [userData.document] : []);
      renderDocList(docs);
      docCount.textContent = docs.length;
    });

    resendVerifyBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      try {
        await currentUser.sendEmailVerification({ url: "https://areahealth-ng.firebaseapp.com" });
        alert("Verification email sent. Please check your inbox.");
      } catch (e) {
        console.error(e);
        alert("Couldn't send verification email. Please try again later.");
      }
    });

    /* ------------------ Profile Picture Upload ------------------ */
    profilePicInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !currentUser) return;

      const ref = storage.ref(`profiles/${currentUser.uid}_${Date.now()}_${file.name}`);
      const task = ref.put(file);

      profileUploadStatus.textContent = 'Uploading…';
      profileProgress.style.width = '0%';

      task.on('state_changed',
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          profileProgress.style.width = pct + '%';
        },
        (err) => {
          console.error(err);
          profileUploadStatus.textContent = 'Upload failed.';
        },
        async () => {
          const url = await ref.getDownloadURL();
          await userDocRef.update({ profilePic: url });
          userPic.src = url;
          headerPic.src = url;
          profileUploadStatus.textContent = 'Profile picture updated!';
        }
      );
    });

    /* ------------------ Document Upload ------------------ */
    let selectedDoc = null;
    documentInput.addEventListener('change', (e) => {
      selectedDoc = e.target.files[0] || null;
      uploadDocBtn.disabled = !selectedDoc;
    });

    uploadDocBtn.addEventListener('click', async () => {
      if (!selectedDoc || !currentUser) return;

      const ref = storage.ref(`documents/${currentUser.uid}_${Date.now()}_${selectedDoc.name}`);
      const task = ref.put(selectedDoc);

      docUploadStatus.textContent = 'Uploading…';
      docProgress.style.width = '0%';
      uploadDocBtn.disabled = true;

      task.on('state_changed',
        (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          docProgress.style.width = pct + '%';
        },
        (err) => {
          console.error(err);
          docUploadStatus.textContent = 'Upload failed.';
          uploadDocBtn.disabled = false;
        },
        async () => {
          const url = await ref.getDownloadURL();
          // Keep an array "documents" of {name, url, ts}
          const entry = { name: selectedDoc.name, url, ts: firebase.firestore.FieldValue.serverTimestamp() };

          await userDocRef.set({
            documents: firebase.firestore.FieldValue.arrayUnion(entry)
          }, { merge: true });

          // Refresh UI
          const updated = await userDocRef.get();
          const docs = updated.data()?.documents || [];
          renderDocList(docs);
          docCount.textContent = docs.length;

          docUploadStatus.textContent = 'Upload complete!';
          uploadDocBtn.disabled = false;
          documentInput.value = '';
          selectedDoc = null;
        }
      );
    });

    function renderDocList(docs) {
      docList.innerHTML = '';
      if (!docs || docs.length === 0) {
        docList.innerHTML = '<li class="text-slate-500">No documents yet.</li>';
        return;
      }
      docs
        .slice()
        .sort((a,b) => (b.ts?.seconds || 0) - (a.ts?.seconds || 0))
        .forEach(d => {
          const li = document.createElement('li');
          li.className = "flex items-center justify-between gap-3 p-2 border border-slate-100 rounded-lg";
          li.innerHTML = `
            <div class="truncate">
              <div class="font-medium truncate">${d.name || 'Document'}</div>
              <div class="text-slate-500 text-xs">${d.ts?.toDate ? new Date(d.ts.toDate()).toLocaleString() : ''}</div>
            </div>
            <a target="_blank" href="${d.url}" class="px-3 py-1 rounded-lg bg-slate-800 text-white text-xs hover:bg-slate-900">View</a>
          `;
          docList.appendChild(li);
        });
    }

    /* ------------------ Nearby Services ------------------ */
    const servicesData = [
      // name, type, location, contact, lat, lng
      { name: "CityCare Pharmacy",    type: "pharmacy",    location: "Yenagoa",    contact: "08012345678", lat: 4.9267, lng: 6.2676 },
      { name: "General Hospital",     type: "hospital",    location: "Otuoke",     contact: "08023456789", lat: 4.7807, lng: 6.3149 },
      { name: "Divine Clinic",        type: "clinic",      location: "Kpansia",    contact: "08034567890", lat: 4.9309, lng: 6.2772 },
      { name: "MegaLab Diagnostics",  type: "laboratory",  location: "Amarata",    contact: "08045678901", lat: 4.9227, lng: 6.2633 },
      { name: "Blessed Pharmacy",     type: "pharmacy",    location: "Opolo",      contact: "08056789012", lat: 4.9346, lng: 6.2958 },
      { name: "Faith Hospital",       type: "hospital",    location: "Okutukutu",  contact: "08067890123", lat: 4.9106, lng: 6.2965 },
      // Added professional helpers:
      { name: "Rapid Response Ambulance", type: "ambulance", location: "Yenagoa", contact: "08070000001", lat: 4.9267, lng: 6.2676 },
      { name: "TeleHealth 24/7",      type: "telemedicine", location: "Online",    contact: "08070000002", lat: 4.9267, lng: 6.2676 },
      { name: "Immunization Centre AMC", type: "vaccination", location: "Yenagoa", contact: "08070000003", lat: 4.9250, lng: 6.2700 },
    ];

    let userPos = null;

    function haversineKm(lat1, lon1, lat2, lon2) {
      const toRad = (v) => v * Math.PI / 180;
      const R = 6371;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function renderServices(filter = 'all', search = '') {
      const grid = document.getElementById('servicesGrid');
      grid.innerHTML = '';

      const filtered = servicesData
        .filter(s =>
          (filter === 'all' || s.type === filter) &&
          (s.name.toLowerCase().includes(search.toLowerCase()) ||
           s.location.toLowerCase().includes(search.toLowerCase())))
        .map(s => {
          let distanceText = '—';
          if (userPos && s.lat && s.lng) {
            const km = haversineKm(userPos.lat, userPos.lng, s.lat, s.lng);
            distanceText = `${km.toFixed(1)} km`;
          }
          return { ...s, distanceText };
        });

      if (filtered.length === 0) {
        grid.innerHTML = '<div class="text-slate-500">No services found.</div>';
        return;
      }

      filtered.forEach(s => {
        const card = document.createElement('div');
        card.className = "rounded-2xl border border-slate-100 p-4 hover:shadow transition";
        const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.name + ' ' + s.location)}`;
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <h4 class="font-semibold">${s.name}</h4>
              <div class="text-slate-600 text-sm">Type: ${capitalize(s.type)}</div>
              <div class="text-slate-600 text-sm">Location: ${s.location}</div>
              <div class="text-slate-600 text-sm">Contact: ${s.contact}</div>
              <div class="text-slate-600 text-sm">Distance: ${s.distanceText}</div>
            </div>
            <div class="flex flex-col gap-2">
              <button class="px-3 py-1 rounded-lg bg-primary text-white text-sm hover:bg-blue-700"
                      onclick="alert('Contacting ${s.name} at ${s.contact}...')">
                Contact
              </button>
              <a target="_blank" href="${mapsLink}"
                 class="px-3 py-1 rounded-lg border border-slate-200 text-sm hover:bg-slate-50 text-center">
                Directions
              </a>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function capitalize(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

    // Filters
    $('filterCategory').addEventListener('change', (e) => {
      renderServices(e.target.value, $('searchBox').value);
    });
    $('searchBox').addEventListener('input', (e) => {
      renderServices($('filterCategory').value, e.target.value);
    });

    // Geolocation
    $('locateBtn').addEventListener('click', () => {
      if (!navigator.geolocation) {
        alert('Geolocation not supported on this device.');
        return;
      }
      navigator.geolocation.getCurrentPosition((pos) => {
        userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        renderServices($('filterCategory').value, $('searchBox').value);
      }, (err) => {
        console.warn(err);
        alert('Could not get your location.');
      }, { enableHighAccuracy: true, timeout: 10000 });
    });

    // Initial render
    renderServices();

    /* ------------------ Logout ------------------ */
    function logout(){
      auth.signOut().then(() => {
        window.location.href = "AreaHealth Login.html";
      });
    }
    window.logout = logout; // expose to global for sidebar button
  </script>
</body>
</html>
